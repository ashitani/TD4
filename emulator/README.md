
# TD4エミュレータ・アセンブラ

[CPUの創りかた](https://www.amazon.co.jp/dp/4839909865)で題材になっている4bit CPU、TD4のエミュレータとアセンブラをpython3で記述したものです。

キーイベント取得のためだけにSDL2を使用しています。下記で導入できます。

```
pip install sdl2
```

# アセンブル

下記のようなコードを例にします。6からFまで数えたら終了です。ラベルが使えます。即値はpythonのマナーで、10進数は10, 16進数は0xA, 2進数は0b1010,というふうに記述してください。

```
        MOV A,6
LOOP:   ADD A,1
        JNC LOOP
        OUT 15
HALT:   JMP HALT
```

下記のようにアセンブルできます。エラーチェック等は全くやっていません。

```
> python assemble src/test.asm
0: 0x36 0b00110110
1: 0x01 0b00000001
2: 0xE1 0b11100001
3: 0xBF 0b10111111
4: 0xF4 0b11110100
5: 0x00 0b00000000
6: 0x00 0b00000000
7: 0x00 0b00000000
8: 0x00 0b00000000
9: 0x00 0b00000000
A: 0x00 0b00000000
B: 0x00 0b00000000
C: 0x00 0b00000000
D: 0x00 0b00000000
E: 0x00 0b00000000
F: 0x00 0b00000000
```

# エミュレータ実行

アセンブラファイルをそのまま突っ込めばアセンブルして実行開始します。同番地へのジャンプはHALTと解釈され終了します。

```
> python run.py src/test.asm
00000:  A[6] B[0] C[0] PC[1] INST[36]    IN[0000] OUT[0000]
00001:  A[7] B[0] C[0] PC[2] INST[01]    IN[0000] OUT[0000]
00002:  A[7] B[0] C[0] PC[1] INST[E1]    IN[0000] OUT[0000]
00003:  A[8] B[0] C[0] PC[2] INST[01]    IN[0000] OUT[0000]
00004:  A[8] B[0] C[0] PC[1] INST[E1]    IN[0000] OUT[0000]
00005:  A[9] B[0] C[0] PC[2] INST[01]    IN[0000] OUT[0000]
00006:  A[9] B[0] C[0] PC[1] INST[E1]    IN[0000] OUT[0000]
00007:  A[A] B[0] C[0] PC[2] INST[01]    IN[0000] OUT[0000]
00008:  A[A] B[0] C[0] PC[1] INST[E1]    IN[0000] OUT[0000]
00009:  A[B] B[0] C[0] PC[2] INST[01]    IN[0000] OUT[0000]
00010:  A[B] B[0] C[0] PC[1] INST[E1]    IN[0000] OUT[0000]
00011:  A[C] B[0] C[0] PC[2] INST[01]    IN[0000] OUT[0000]
00012:  A[C] B[0] C[0] PC[1] INST[E1]    IN[0000] OUT[0000]
00013:  A[D] B[0] C[0] PC[2] INST[01]    IN[0000] OUT[0000]
00014:  A[D] B[0] C[0] PC[1] INST[E1]    IN[0000] OUT[0000]
00015:  A[E] B[0] C[0] PC[2] INST[01]    IN[0000] OUT[0000]
00016:  A[E] B[0] C[0] PC[1] INST[E1]    IN[0000] OUT[0000]
00017:  A[F] B[0] C[0] PC[2] INST[01]    IN[0000] OUT[0000]
00018:  A[F] B[0] C[0] PC[1] INST[E1]    IN[0000] OUT[0000]
00019:  A[0] B[0] C[1] PC[2] INST[01]    IN[0000] OUT[0000]
00020:  A[0] B[0] C[1] PC[3] INST[E1]    IN[0000] OUT[0000]
00021:  A[0] B[0] C[1] PC[4] INST[BF]    IN[0000] OUT[1111]
00022:  A[0] B[0] C[1] PC[4] INST[F4]    IN[0000] OUT[1111]
HALTED
```

クロック周波数を変えたい場合は引数に[Hz]を与えてください。

```
> python sim.py src/test.asm 100
```

INポートを変更するには、直接キーボードから0-9,A-Fのキーを入力すると反映されます。

# その他

本誌内に記載のあるプログラム(blink.asm, ramen.asm)も載せてあります。

